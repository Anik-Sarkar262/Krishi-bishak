<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishi-Bhishak - Crop Disease Detector</title>
    <link rel="stylesheet" href="dashboard.css">
    <!-- <style>
        :root {
            --primary: #2e7d32; /* Crop Green */
            --primary-dark: #1b5e20;
            --secondary: #1976d2; /* Tech Blue for Community/Alerts */
            --accent: #ffca28; /* Harvest Yellow */
            --danger: #d32f2f;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }

        body { background-color: var(--bg-light); color: var(--text-dark); height: 100vh; display: flex; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background: var(--white);
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem; font-weight: 700; color: var(--primary); margin-bottom: 2rem; }
        .logo svg { width: 28px; height: 28px; fill: var(--primary); }

        .nav-link {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
            border-radius: var(--radius); color: var(--text-light); text-decoration: none;
            margin-bottom: 0.5rem; font-weight: 500; cursor: pointer; transition: 0.2s;
        }
        .nav-link:hover, .nav-link.active { background-color: #e8f5e9; color: var(--primary); }
        .nav-link svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- Main Layout --- */
        .main-content { flex: 1; overflow-y: auto; padding: 2rem; position: relative; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        
        /* --- Grid & Cards --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        
        .card { background: var(--white); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .card h3 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark); display: flex; justify-content: space-between; }

        /* --- Alert Banners --- */
        .alert-banner {
            background-color: #fff3cd; color: #856404; padding: 1rem; border-radius: var(--radius);
            margin-bottom: 1.5rem; border-left: 5px solid #ffc107; display: flex; align-items: center; gap: 1rem;
        }
        .alert-banner svg { width: 24px; height: 24px; fill: #856404; }

        /* --- Treatment Tracker --- */
        .task-item {
            display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;
        }
        .task-checkbox { width: 18px; height: 18px; margin-right: 1rem; accent-color: var(--primary); }
        .task-info { flex: 1; }
        .task-title { font-weight: 500; font-size: 0.95rem; }
        .task-date { font-size: 0.8rem; color: var(--text-light); }
        .task-tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; background: #e3f2fd; color: #1565c0; margin-left: 0.5rem; }

        /* --- Community Feed --- */
        .community-post {
            border: 1px solid #e5e7eb; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;
            display: flex; gap: 1rem; background: #fafafa;
        }
        .post-img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #ddd; }
        .post-content { flex: 1; }
        .post-header { display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: 600; }
        .post-votes { display: flex; gap: 1rem; margin-top: 0.5rem; }
        .vote-btn { background: none; border: 1px solid #e5e7eb; padding: 4px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
        .vote-btn:hover { background: #f3f4f6; }
        .vote-btn.agree.active { background: #e8f5e9; color: var(--primary); border-color: var(--primary); }
        .vote-btn.disagree.active { background: #ffebee; color: var(--danger); border-color: var(--danger); }

        /* --- SMS Section --- */
        .sms-input-group { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .sms-input { flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 24px; margin-left: auto; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* --- General UI --- */
        .btn-primary { background: var(--primary); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; }
        .hidden { display: none !important; }

        /* --- Toast Notification --- */
        .toast {
            position: fixed; bottom: 20px; right: 20px; background: #333; color: white;
            padding: 12px 24px; border-radius: 8px; z-index: 200;
            transform: translateY(100px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px;
        }
        .toast.show { transform: translateY(0); }
        .toast-success { border-left: 4px solid var(--primary); }

        /* Modal Enhancements */
        .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .modal-actions button { font-size: 0.9rem; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; z-index: 50; }
            .sidebar.active { left: 0; }
            .menu-toggle { display: block; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        }
        @media (min-width: 769px) { .menu-toggle { display: none; } }
    </style> -->
</head>
<body>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="logo">
        <svg viewBox="0 0 24 24"><path d="M12,2A7,7 0 0,1 19,9C19,11.38 17.81,13.47 16,14.74V17A1,1 0 0,1 15,18H9A1,1 0 0,1 8,17V14.74C6.19,13.47 5,11.38 5,9A7,7 0 0,1 12,2M9,21V20H15V21A1,1 0 0,1 14,22H10A1,1 0 0,1 9,21M12,4A5,5 0 0,0 7,9C7,11.05 8.23,12.81 10,13.58V16H14V13.58C15.77,12.81 17,11.05 17,9A5,5 0 0,0 12,4Z"/></svg>
        Krishi-Bhishak
    </div>
    <div style="flex:1">
        <a class="nav-link active" onclick="showView('dashboard')">
            <svg viewBox="0 0 24 24"><path d="M3,13H11V3H3V13M3,21H11V15H3V21M13,21H21V11H13V21M13,3V9H21V3H13Z"/></svg> Dashboard
        </a>
        <a class="nav-link" onclick="window.location.href='analyser.html'">
            <svg viewBox="0 0 24 24" ><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7Z"/></svg> Upload Image
        </a>
         <!-- <a class="nav-link" onclick="showView('community')">
            <svg viewBox="0 0 24 24"><path d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,6.33 8.28,5 12,5C15.72,5 18.44,6.33 19,8V12.5C19,14.25 16.31,15.77 12.75,15.98L12,17.5L11.25,15.98C7.69,15.77 5,14.25 5,12.5V8M12,3.5A5.5,5.5 0 0,0 6.5,9A
        </a> -->
        <a class="nav-link" onclick="showView('tasks')">
            <svg viewBox="0 0 24 24"><path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M17,11H7V9H17V11M17,15H7V13H17V15Z"/></svg> Treatment Tracker
        </a>
        <a class="nav-link" onclick="showView('settings')">
            <svg viewBox="0 0 24 24"><path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z"/></svg> Alerts & SMS
        </a> 
    </div>
    <div style="display:flex; align-items:center; gap:0.5rem; font-size:0.9rem; border-top:1px solid #eee; padding-top:1rem;">
        <img src="https://picsum.photos/seed/farmer/40/40" style="border-radius:50%">
        <div>
            <div style="font-weight:600;">John Doe</div>
            <div style="font-size:0.75rem; color:#888;">Pro Farmer</div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content">
    <header>
        <div style="display:flex; align-items:center; gap:1rem;">
            <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('active')">‚ò∞</button>
            <h1 id="page-title">Dashboard</h1>
        </div>
        <div style="font-size:0.9rem; color:var(--text-light);" id="current-date"></div>
    </header>

    <!-- DASHBOARD VIEW -->
    <section id="dashboard-view">
        <!-- Prevention Alert Widget -->
        <div class="alert-banner" id="weather-alert">
            <svg viewBox="0 0 24 24"><path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/></svg>
            <div>
                <strong>Prevention Alert:</strong> High humidity detected in your region (85%). Risk of fungal infection (Late Blight) is elevated. Check crops daily.
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Health Stats -->
            <div class="card">
                <h3>Crop Health Score <span style="color:var(--primary)">92%</span></h3>
                <div style="height:8px; background:#eee; border-radius:4px; margin-bottom:1rem;">
                    <div style="width:92%; height:100%; background:var(--primary); border-radius:4px;"></div>
                </div>
                <div style="font-size:0.85rem; color:#666;">+4% from last week</div>
            </div>
            
            <!-- Upcoming Task Widget -->
            <div class="card">
                <h3>Next Treatment <span onclick="showView('tasks')" style="font-size:0.8rem; cursor:pointer; color:var(--secondary)">View All</span></h3>
                <div id="next-task-display" style="color:var(--text-dark); font-weight:500;">
                    No pending tasks.
                </div>
                <div id="next-task-date" style="font-size:0.8rem; color:#888; margin-top:5px;"></div>
            </div>

            <!-- Community Activity Widget -->
             <div class="card">
                <!-- <h3> <span style="font-size:0.8rem; background:#e3f2fd; color:#1565c0; padding:2px 6px; border-radius:4px;">Live</span></h3>
                <div style="display:flex; align-items:center; gap:0.5rem; font-size:0.9rem;">
                    <img src="https://picsum.photos/seed/u2/30/30" style="border-radius:50%">
                    <div><strong>Sarah K.</strong> verified a Rust case.</div>
                </div>
            </div>
        </div> -->

        <div class="card">
            <h3>Recent Scans</h3>
            <table style="width:100%; border-collapse:collapse; margin-top:1rem;">
                <thead>
                    <tr style="text-align:left; color:#666; font-size:0.9rem; border-bottom:1px solid #eee;">
                        <th style="padding:10px;">Crop</th>
                        <th style="padding:10px;">Result</th>
                        <th style="padding:10px;">Date</th>
                        <th style="padding:10px;">Action</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- SCANNER VIEW -->
        
    <!-- <section id="scanner-view" class="hidden">
        <div class="card" style="text-align:center; max-width:600px; margin:0 auto;">
            <h2>AI Disease Scanner</h2>
            <p style="color:#666; margin-bottom:2rem;">Upload leaf image for Python CNN Analysis.</p>
            
            <div id="upload-zone" style="border:2px dashed #ccc; padding:3rem; border-radius:12px; cursor:pointer; transition:0.3s;" onclick="document.getElementById('fileInput').click()">
                <svg style="width:48px; height:48px; fill:#ccc" viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg>
                <p>Click to Upload Image</p>
            </div>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="processUpload(this)">

            <div id="processing-ui" class="hidden" style="margin-top:2rem;">
                <div style="font-weight:600; margin-bottom:0.5rem;" id="process-text">Analyzing...</div>
                <div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;">
                    <div id="process-bar" style="height:100%; width:0%; background:var(--primary); transition:width 0.3s;"></div>
                </div>
            </div>
        </div>
    </section> -->

    <!-- COMMUNITY VIEW -->
    <section id="community-view" class="hidden">
        <div class="card">
            <h3>Community Validation <span style="font-size:0.8rem; font-weight:400;">Help fellow farmers verify AI results.</span></h3>
            <div id="community-feed"> 
                <!-- Mock posts -->
            </div>
        </div>
    </section>

    <!-- TASKS/TRACKER VIEW -->
    <section id="tasks-view" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Treatment Tracker</h3>
                <button class="btn-primary" onclick="addManualTask()">+ Add Manual Task</button>
            </div>
            <div id="task-list" style="margin-top:1rem;">
                <!-- Tasks injected here -->
            </div>
        </div>
    </section>

    <!-- SETTINGS/ALERTS VIEW -->
    <section id="settings-view" class="hidden">
        <div class="card">
            <h3>SMS & Alert Integration</h3>
            <p style="color:#666; font-size:0.9rem; margin-bottom:1rem;">Receive instant SMS when high-risk diseases are detected or prevention alerts trigger.</p>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <div>
                    <strong>Enable SMS Alerts</strong>
                    <div style="font-size:0.8rem; color:#888;">Send alerts to mobile number</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="sms-toggle" onchange="toggleSMS()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="sms-input-group">
                <input type="tel" id="phone-number" class="sms-input" placeholder="+1 (555) 000-0000" value="+1 555 012 3456">
                <button class="btn-primary" onclick="savePhone()">Update</button>
            </div>

            <div style="margin-top:2rem;">
                <h4>Alert History</h4>
                <ul id="alert-log" style="list-style:none; margin-top:0.5rem; font-size:0.9rem; color:#555;">
                    <li style="padding:0.5rem 0; border-bottom:1px solid #eee;">Oct 24 - SMS Sent: High humidity warning.</li>
                    <li style="padding:0.5rem 0; border-bottom:1px solid #eee;">Oct 22 - In-App: Rust detected in North sector.</li>
                </ul>
            </div>
        </div>
    </section>

</main>

<!-- Result Modal -->
<div id="result-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:100;">
    <div style="background:white; width:90%; max-width:500px; padding:2rem; border-radius:12px; position:relative;">
        <button onclick="closeModal()" style="position:absolute; top:1rem; right:1rem; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        
        <h2 id="modal-title" style="color:var(--danger); margin-bottom:0.5rem;">Late Blight</h2>
        <div style="margin-bottom:1rem; color:#666;">
            Confidence: <span id="modal-conf" style="font-weight:700; color:var(--primary);">94%</span>
        </div>
        
        <p id="modal-desc" style="line-height:1.6; color:#333; margin-bottom:1.5rem;">
            Fungal infection detected. Action required immediately.
        </p>

        <div style="background:#f9f9f9; padding:1rem; border-radius:8px; margin-bottom:1.5rem;">
            <strong>Treatment:</strong> <span id="modal-treat">Apply fungicide. Remove infected leaves.</span>
        </div>

        <!-- New Feature Actions -->
        <div class="modal-actions">
            <button class="btn-primary" onclick="addToTrackerFromModal()">Track Treatment</button>
            <!-- <button class="btn-outline" onclick="askCommunity()">Ask Community</button> -->
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast toast-success">
    <svg style="width:20px; height:20px; fill:#4caf50" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M10,17L5,12L6.41,10.59L10,14.17L17.59,6.58L19,8L10,17Z"/></svg>
    <span id="toast-msg">Success</span>
</div>

<!-- <script>
    // --- State ---
    const state = {
        scans: [
            { crop: 'Tomato', disease: 'Healthy', date: '2023-10-24', conf: '99%', type: 'good' },
            { crop: 'Potato', disease: 'Early Blight', date: '2023-10-22', conf: '88%', type: 'bad' },
            { crop: 'Corn', disease: 'Healthy', date: '2023-10-20', conf: '96%', type: 'good' },
        ],
        tasks: [
            { id: 1, text: 'Apply Fungicide on Potato Row A', date: '2023-10-25', done: false, tag: 'Urgent' },
            { id: 2, text: 'Irrigate Tomato Sector 2', date: '2023-10-26', done: false, tag: 'Routine' }
        ],
        community: [
            { id: 1, user: 'Mike R.', crop: 'Wheat', issue: 'Leaf Rust', votes: 12, img: 'https://picsum.photos/seed/c1/80/80' },
            { id: 2, user: 'Anna L.', crop: 'Soybean', issue: 'Downy Mildew', votes: 8, img: 'https://picsum.photos/seed/c2/80/80' },
            { id: 3, user: 'David B.', crop: 'Corn', issue: 'Northern Corn Leaf Blight', votes: 24, img: 'https://picsum.photos/seed/c3/80/80' }
        ],
        currentScanResult: null,
        smsEnabled: false
    };

    // --- Navigation ---
    function showView(viewName) {
        // Hide all
        ['dashboard', 'scanner', 'community', 'tasks', 'settings'].forEach(v => {
            document.getElementById(`${v}-view`).classList.add('hidden');
        });
        // Show target
        document.getElementById(`${viewName}-view`).classList.remove('hidden');
        
        // Active Link
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // Refresh specific components
        if(viewName === 'tasks') renderTasks();
        if(viewName === 'community') renderCommunity();
        if(viewName === 'dashboard') renderHistory();
        
        // Mobile menu close
        document.getElementById('sidebar').classList.remove('active');
    }

    // --- Rendering ---
    function renderHistory() {
        const tbody = document.getElementById('history-table-body');
        tbody.innerHTML = state.scans.map(s => `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:10px;">${s.crop}</td>
                <td style="padding:10px; color:${s.type === 'bad' ? 'var(--danger)' : 'var(--primary)'}">${s.disease}</td>
                <td style="padding:10px;">${s.date}</td>
                <td style="padding:10px;"><button class="btn-outline" style="padding:2px 8px; font-size:0.8rem;">View</button></td>
            </tr>
        `).join('');
        
        // Update Widget
        const pending = state.tasks.filter(t => !t.done)[0];
        const widget = document.getElementById('next-task-display');
        const widgetDate = document.getElementById('next-task-date');
        if(pending) {
            widget.textContent = pending.text;
            widgetDate.textContent = `Due: ${pending.date}`;
            widgetDate.style.color = 'var(--danger)';
        } else {
            widget.textContent = "No pending tasks.";
            widgetDate.textContent = "";
        }
    }

    function renderTasks() {
        const list = document.getElementById('task-list');
        list.innerHTML = state.tasks.map(t => `
            <div class="task-item" style="opacity: ${t.done ? '0.5' : '1'}">
                <input type="checkbox" class="task-checkbox" ${t.done ? 'checked' : ''} onchange="toggleTask(${t.id})">
                <div class="task-info">
                    <div class="task-title" style="text-decoration: ${t.done ? 'line-through' : 'none'}">${t.text}</div>
                    <div class="task-date">Due: ${t.date} <span class="task-tag">${t.tag}</span></div>
                </div>
            </div>
        `).join('');
    }

    function renderCommunity() {
        const feed = document.getElementById('community-feed');
        feed.innerHTML = state.community.map(c => `
            <div class="community-post">
                <img src="${c.img}" class="post-img">
                <div class="post-content">
                    <div class="post-header">
                        <span>${c.user}</span>
                        <span style="color:var(--primary)">${c.crop}</span>
                    </div>
                    <div style="font-size:0.9rem;">${c.issue}</div>
                    <div class="post-votes">
                        <button class="vote-btn agree" onclick="vote(this)">üëç Agree <span>${c.votes}</span></button>
                        <button class="vote-btn disagree" onclick="vote(this)">üëé Disagree</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // --- Scanner Logic (Mock Backend) ---
    function processUpload(input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('upload-zone').classList.add('hidden');
        document.getElementById('processing-ui').classList.remove('hidden');

        // Simulate Steps
        const bar = document.getElementById('process-bar');
        const txt = document.getElementById('process-text');
        let width = 0;
        
        const interval = setInterval(() => {
            if (width >= 100) {
                clearInterval(interval);
                // Mock Result
                state.currentScanResult = {
                    name: "Late Blight",
                    conf: "94%",
                    desc: "Phytophthora infestans detected. Water-soaked spots on leaves.",
                    treat: "Apply Mancozeb immediately. Remove infected tissue."
                };
                showResultModal();
                // Reset UI
                setTimeout(() => {
                    document.getElementById('upload-zone').classList.remove('hidden');
                    document.getElementById('processing-ui').classList.add('hidden');
                    input.value = "";
                    bar.style.width = '0%';
                }, 500);
            } else {
                width += 5;
                bar.style.width = width + '%';
                if(width < 30) txt.textContent = "Uploading to Python Server...";
                else if(width < 70) txt.textContent = "AI Model Analyzing (CNN)...";
                else txt.textContent = "Comparing with database...";
            }
        }, 100);
    }

    // --- Modal & Actions ---
    function showResultModal() {
        document.getElementById('modal-title').textContent = state.currentScanResult.name;
        document.getElementById('modal-conf').textContent = state.currentScanResult.conf;
        document.getElementById('modal-desc').textContent = state.currentScanResult.desc;
        document.getElementById('modal-treat').textContent = state.currentScanResult.treat;
        document.getElementById('result-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        showView('dashboard'); // Go back home
    }

    function addToTrackerFromModal() {
        const newTask = {
            id: Date.now(),
            text: `Treat: ${state.currentScanResult.name}`,
            date: new Date(Date.now() + 86400000 * 2).toISOString().split('T')[0], // 2 days from now
            done: false,
            tag: 'Urgent'
        };
        state.tasks.unshift(newTask);
        showToast("Task added to tracker!");
        closeModal();
    }

    function askCommunity() {
        const post = {
            id: Date.now(),
            user: 'You (John Doe)',
            crop: 'Unknown',
            issue: state.currentScanResult.name,
            votes: 0,
            img: 'https://picsum.photos/seed/new/80/80'
        };
        state.community.unshift(post);
        showToast("Posted to Community for validation!");
        closeModal();
    }

    // --- Task Management ---
    function toggleTask(id) {
        const task = state.tasks.find(t => t.id === id);
        if(task) task.done = !task.done;
        renderTasks();
        renderHistory(); // Update widget
    }

    function addManualTask() {
        const text = prompt("Enter task description:");
        if(text) {
            state.tasks.unshift({
                id: Date.now(),
                text: text,
                date: new Date().toISOString().split('T')[0],
                done: false,
                tag: 'Manual'
            });
            renderTasks();
        }
    }

    // --- SMS & Alerts Logic ---
    function toggleSMS() {
        state.smsEnabled = document.getElementById('sms-toggle').checked;
        if(state.smsEnabled) showToast("SMS Alerts Enabled");
    }

    function savePhone() {
        showToast("Phone number updated!");
    }

    function vote(btn) {
        // Visual feedback only
        if(btn.classList.contains('active')) {
            btn.classList.remove('active');
        } else {
            // Remove active from sibling
            const parent = btn.parentElement;
            parent.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // If it's a new scan being posted, simulate SMS notification to followers
            if(state.smsEnabled && Math.random() > 0.5) {
                setTimeout(() => showToast("üì≤ SMS Sent: Neighbor posted new case"), 1000);
            }
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // --- Init ---
    document.getElementById('current-date').textContent = new Date().toDateString();
    renderHistory(); -->

<!-- </script> -->
<script src="script.js"></script>
</body>
</html>